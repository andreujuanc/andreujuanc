<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <!-- EVERYTHING IS INLINE ON PURPOSE!! -->
    <title>Juan C. Andreu - Software Architect</title>
    <meta name="description" content="Welcome to Juan Carlos Andreu's landing page.">
    <meta name="author" content="Juan C. Andreu">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-9724156-11"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-9724156-11');
    </script>

    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            min-height: 100%;
            margin: 0;
        }

        body {
            background-color: initial;
            transition: background-color 0.3s ease-in-out;
        }

        body.background {
            background-color: #151515;
        }

        .wrapper {

            height: 100%;
            display: grid;
            justify-content: left;
            grid-template-rows: 1fr 2fr 1fr;

            grid-template-columns: 15% auto 15%;
            grid-template-areas: ". . ." ". center ." ". . .";


            font-family: monospace;

            font-size: 1.4rem;
        }

        .wrapper,
        a {
            color: #DDD;
        }

        @media (max-width: 600px) {
            .wrapper {
                font-size: 1.2rem;
                grid-template-columns: auto;
                grid-template-areas: "." "center" ".";
                margin-left: 1.3rem;
            }
        }

        @media (max-width: 450px) {
            .wrapper {
                font-size: 1rem;
            }
        }

        .center-screen {
            grid-area: center;
            align-self: center;
        }

        #logo {
            position: absolute;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.7rem;
            color: #DDD;
            padding: 10px;
            top: 0;
            bottom: auto;
            left: auto;
            right: 0;
        }

        .reverse {
            unicode-bidi: bidi-override;
            direction: rtl;
        }
    </style>

</head>

<body>
    <div id="logo">
        Andr.eu OS v0.1 | Copyleft 2017
    </div>
    <div class="wrapper screen">
        <div class="center-screen">
            <div id="output"></div>
            <div id="input">
                <span id="consolelocation"></span>
                <span id="inputtext"></span>
                <span id="consoleprompt">_</span>
            </div>
        </div>

    </div>
    <script>
        function AndreuOS() {
            let outBuffer = [];
            let line = '';
            let welcomeText = ['Welcome to Juan C. Andreu\'s home portal.',
                'Type help for a list of commands.'];
            let location = 'guest@andr.eu:~$';
            let promptText = null;
            let promptCallback = null;
            let currentCommand = null;
            let m = "contact", m2 = "andreujuan", m3 = ['m', 'o', 'c', '.'].reverse().join('');
            function getSign() { return "@"; }
            let commands = [
                {
                    name: 'help',
                    description: "Shows help",
                    exec: function (args) {
                        outBuffer.push("Help!")
                        commands.map(x => outBuffer.push("Command: " + x.name + " - " + x.description))
                    }
                },
                {
                    name: 'echo', description: "Displays message", exec: function (args) { outBuffer.push(args.join(' ')); }
                },
                {
                    name: 'clear', description: "Clears the console", exec: function () { clear(); }
                },
                {
                    name: 'info',
                    description: "Shows Juan's Info",
                    exec: function (args) {
                        clear();

                        outBuffer.push('*******************************');
                        outBuffer.push('  Juan Carlos Andreu GutiÃ©rrez   ');
                        outBuffer.push('  Software Architect    ');
                        outBuffer.push('  ' + m + getSign() + m2 + m3);
                        outBuffer.push('  @Madrid ');
                        outBuffer.push('*******************************');
                    }
                },
                {
                    name: 'contact',
                    description: "Contact me!",
                    exec: function (args) {
                        return new Promise(function (resolve, reject) {
                            clear();
                            writeConsole('Please fill the form:');
                            var contactData = {

                            };
                            read('Name:')
                                .then(function (x) {
                                    outBuffer.push('Name: ' + x);
                                    contactData.name = x;
                                })
                                .then(read.bind(this, "Email:"))
                                .then(function (x) {
                                    outBuffer.push('Email: ' + x);
                                    contactData.email = x;
                                })
                                .then(read.bind(this, "Message:"))
                                .then(function (x) {
                                    outBuffer.push('Message: ' + x);
                                    contactData.message = x;
                                })
                                .then(function () {
                                    let action = "http://formspree.io/" + m + getSign() + m2 + m3;
                                    let form = new FormData();
                                    for (var i in contactData) {
                                        form.append(i, contactData[i]);
                                    }
                                    outBuffer.push('Sending... please wait.');
                                    fetch(action, {
                                        method: "POST",
                                        body: form
                                    })
                                        .then(function (response) {
                                            if (response.ok)
                                                outBuffer.push('Thank you ' + contactData.name + '! I will contact you as soon as possible.');
                                            else {
                                                console.error(response);
                                                outBuffer.push('Ups! there was an error, please use the info command and send me an email.');

                                            }
                                        }).catch(function (error) {
                                            console.error(error);
                                            outBuffer.push('Ups! there was an error, please use the info command and send me an email.');
                                        });

                                })
                                .then(resolve);
                        });
                    }
                }];

            function init() {
                document.body.classList.add("background");
                outBuffer.push(welcomeText[0]);
                outBuffer.push(welcomeText[1]);
                sendBuffer();
            }

            function read(msg) {
                setPromptText(msg);
                return new Promise(function (resolve, reject) {
                    promptCallback = function (textResult) {
                        resolve(textResult);
                    };
                    //resolve(resol)
                });
            }

            function onkeypress(args) {
                if ((args.keyCode > 64 && args.keyCode <= 90) || args.keyCode === 32)
                    inputtext.textContent += args.key;
                else if (args.keyCode == 8)
                    inputtext.textContent = inputtext.textContent.substr(0, inputtext.textContent.length - 1);
                else if (args.keyCode == 13) {
                    let result = inputtext.textContent;
                    inputtext.textContent = '';
                    if (currentCommand !== null && typeof promptCallback === 'function')
                        promptCallback(result);
                    else
                        parseLine(result);
                }
            }

            function parseLine(text) {
                if (typeof text !== 'string') return false;
                var words = text.replace(/ /g, ' ').split(' ');
                if (words.length === 0) return false;
                command(words[0], words.length > 0 ? words.splice(1, words.length - 1) : undefined);
                return true;
            }

            function command(name, args) {
                let command = commands.find(x => x.name === name);
                if (typeof command === 'undefined' || command === null) return outBuffer.push('Error, Command not found.');
                currentCommand = command;
                var result = command.exec(args);

                if (typeof result === 'undefined' || result === null) {
                    currentCommand = null;
                    return;
                }

                if (typeof result.then === 'function') {
                    result.then(function () {
                        currentCommand = null;
                        promptText = null;
                    }, function (error) {
                        currentCommand = null;
                        alert(error);
                    })
                }
                else
                    currentCommand = null;
            }

            function clear() {
                output.innerHTML = '';
            }

            function writeConsole(text) {
                if (typeof text !== 'string') return false;
                var newLine = document.createElement('div');
                newLine.innerHTML = text;
                output.appendChild(newLine);
                return true;
            }

            function setPromptText(text) {
                promptText = text;
                consolelocation.textContent = promptText;
            }
            function sendBuffer() {
                if (typeof promptText != 'undefined' && promptText !== null)
                    setPromptText(promptText);
                else
                    setPromptText(location);

                let text = outBuffer;
                outBuffer = [];
                if (!Array.isArray(text)) {
                    text = [text];
                }

                let animatePrompt = function () {
                    if (consoleprompt.style.opacity == '0')
                        consoleprompt.style.opacity = 1;
                    else
                        consoleprompt.style.opacity = 0;
                    setTimeout(sendBuffer, 500);
                }

                let queueNext = function () {
                    if (writeConsole(text.shift()))
                        setTimeout(queueNext, (Math.random() * 25) + 25);
                    else
                        animatePrompt();
                }
                queueNext();
            }
            return {
                init: init,
                onkeypress: onkeypress
            }
        }
        let os = new AndreuOS();
        window.onload = os.init
        window.onkeyup = os.onkeypress;
    </script>
</body>

</html>